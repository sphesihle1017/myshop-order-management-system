@{
    ViewData["Title"] = "Shopping Cart";
}

<div class="container mt-4">
    <h2><i class="bi bi-cart me-2"></i>Shopping Cart</h2>

    <!-- Cart will be populated by JavaScript -->
    <div id="cartContainer">
        <!-- Loading spinner -->
        <div class="text-center py-5" id="cartLoading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading cart...</span>
            </div>
            <p class="mt-3">Loading your cart...</p>
        </div>

        <!-- Empty cart message (hidden by default) -->
        <div class="alert alert-info text-center py-5" id="emptyCartMessage" style="display: none;">
            <div class="mb-3">
                <i class="bi bi-cart text-muted" style="font-size: 4rem;"></i>
            </div>
            <h4>Your cart is empty</h4>
            <p class="mb-4">Add some products to get started!</p>
            <a asp-controller="Home" asp-action="Index" class="btn btn-primary btn-lg">
                <i class="bi bi-arrow-left me-2"></i>Continue Shopping
            </a>
        </div>

        <!-- Cart content (hidden by default) -->
        <div id="cartContent" style="display: none;">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="cartTable">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Price</th>
                                            <th>Quantity</th>
                                            <th>Size</th>
                                            <th>Total</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cartItems">
                                        <!-- Cart items will be inserted here by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Order Summary</h5>
                            <hr>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Items:</span>
                                <span id="totalItems">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Total:</strong>
                                <strong class="text-primary" id="totalPrice">R 0.00</strong>
                            </div>
                           
                            <div class="d-grid gap-2">
                                <!-- In Cart/Index.cshtml, add this button near the checkout button: -->
                                <button class="btn btn-primary" id="checkoutBtn" onclick="proceedToCheckout()">
                                    <i class="bi bi-bag-check me-2"></i>Proceed to Checkout
                                </button>

                                <script>
                                    function proceedToCheckout() {
                                        const cart = cartManager.getCart();

                                        if (cart.length === 0) {
                                            alert('Your cart is empty!');
                                            return;
                                        }

                                        // Redirect to checkout page
                                        window.location.href = '/Checkout';
                                    }
                                </script>
                                <button class="btn btn-outline-danger" id="clearCartBtn">
                                    <i class="bi bi-trash me-2"></i>Clear Cart
                                </button>
                                <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-2"></i>Continue Shopping
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Load cart on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCart();
        });

        function loadCart() {
            const cart = cartManager.getCart();
            const cartItemsContainer = document.getElementById('cartItems');
            const cartLoading = document.getElementById('cartLoading');
            const cartContent = document.getElementById('cartContent');
            const emptyCartMessage = document.getElementById('emptyCartMessage');

            // Hide loading spinner
            cartLoading.style.display = 'none';

            if (cart.length === 0) {
                // Show empty cart message
                emptyCartMessage.style.display = 'block';
                cartContent.style.display = 'none';
            } else {
                // Show cart content
                emptyCartMessage.style.display = 'none';
                cartContent.style.display = 'block';

                // Clear existing items
                cartItemsContainer.innerHTML = '';

                // Add cart items to table
                cart.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <strong>${item.productName}</strong>
                            <br>
                           
                        </td>
                        <td>R ${item.price.toFixed(2)}</td>
                        <td>
                            <input type="number"
                                   class="form-control form-control-sm quantity-input"
                                   value="${item.quantity}"
                                   min="1"
                                   style="width: 80px;"
                                   data-product-id="${item.productId}">
                        </td>
                          <td>
                            <select id="sizes">
                                 <option value="${item.Size}">Small</option>
                                 <option value="${item.Size}">Medium</option>
                                 <<option value="${item.Size}">Large</option>
                                 
                            </select>
                           
                                
                                
                        </td>

                        <td class="item-total">R ${(item.price * item.quantity).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger remove-item"
                                    data-product-id="${item.productId}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    cartItemsContainer.appendChild(row);
                });

                // Update totals
                updateCartTotals();

                // Add event listeners
                addCartEventListeners();
            }
        }

        function updateCartTotals() {
            const cart = cartManager.getCart();
            const totalItems = cartManager.getTotalItems();
            const totalPrice = cartManager.getTotalPrice();

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalPrice').textContent = 'R ' + totalPrice.toFixed(2);
        }

        function addCartEventListeners() {
            // Update quantity
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', function() {
                    const productId = this.getAttribute('data-product-id');
                    const quantity = parseInt(this.value);

                    if (quantity < 1) {
                        this.value = 1;
                        return;
                    }

                    cartManager.updateQuantity(productId, quantity);
                    updateCartItemTotal(productId, quantity);
                    updateCartTotals();
                    cartManager.updateCartBadge();
                });
            });

            // Remove item
            document.querySelectorAll('.remove-item').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');

                    if (confirm('Remove this item from cart?')) {
                        cartManager.removeFromCart(productId);
                        loadCart(); // Reload the cart display
                    }
                });
            });
        }

        function updateCartItemTotal(productId, quantity) {
            const cart = cartManager.getCart();
            const item = cart.find(item => item.productId == productId);

            if (item) {
                const row = document.querySelector(`.quantity-input[data-product-id="${productId}"]`).closest('tr');
                const totalCell = row.querySelector('.item-total');
                totalCell.textContent = 'R ' + (item.price * quantity).toFixed(2);
            }
        }

        // Clear cart
        document.getElementById('clearCartBtn')?.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear your entire cart?')) {
                cartManager.clearCart();
                loadCart();
            }
        });

        // Checkout (placeholder)
        document.getElementById('checkoutBtn')?.addEventListener('click', function() {
            const cart = cartManager.getCart();

            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }
            // For now, just show a confirmation
            alert(`Proceeding to checkout with ${cartManager.getTotalItems()} items. Total: R ${cartManager.getTotalPrice().toFixed(2)}`);

            //Save cart to server/database before checkout
             cartManager.syncWithServer();
        });
    </script>
}