@model IEnumerable<MyShop.Models.Checkout>

@{
    ViewData["Title"] = "Trash - Order Management";
    ViewData["ActivePage"] = "Orders";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">
            <i class="fas fa-trash-alt text-danger"></i> Trash
        </h1>
        <div class="btn-group">
            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Orders
            </a>
            <form method="post" asp-action="EmptyTrash" class="d-inline"
                  onsubmit="return confirm('Are you sure you want to permanently delete ALL orders in trash? This action cannot be undone.');">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-danger ml-2">
                    <i class="fas fa-trash"></i> Empty Trash
                </button>
            </form>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-danger">Search Deleted Orders</h6>
        </div>
        <div class="card-body">
            <form method="get" class="form-inline">
                <div class="input-group mb-2 mr-sm-2" style="width: 300px;">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                    </div>
                    <input type="text" class="form-control" name="search"
                           placeholder="Search deleted orders..." value="@ViewBag.SearchTerm">
                </div>

                <select class="form-control mb-2 mr-sm-2" name="sort">
                    <option value="newest" selected="@(ViewBag.CurrentSort == "newest")">Recently Deleted</option>
                    <option value="oldest" selected="@(ViewBag.CurrentSort == "oldest")">Oldest Deleted</option>
                    <option value="oldest-order" selected="@(ViewBag.CurrentSort == "oldest-order")">Oldest Order Date</option>
                </select>

                <button type="submit" class="btn btn-primary mb-2">
                    <i class="fas fa-filter"></i> Apply
                </button>
                <a href="@Url.Action("Trash")" class="btn btn-secondary mb-2 ml-2">
                    <i class="fas fa-times"></i> Clear
                </a>
            </form>
        </div>
    </div>

    <!-- Bulk Actions -->
    @if (Model.Any())
    {
        <div class="card shadow mb-4">
            <div class="card-body">
                <button type="button" class="btn btn-success btn-sm" id="restoreSelectedBtn" disabled>
                    <i class="fas fa-undo"></i> Restore Selected
                </button>
                <button type="button" class="btn btn-danger btn-sm ml-2" id="deleteSelectedBtn" disabled>
                    <i class="fas fa-trash"></i> Delete Permanently
                </button>
                <button type="button" class="btn btn-secondary btn-sm ml-2" id="selectAllBtn">
                    <i class="fas fa-check-square"></i> Select All
                </button>
                <button type="button" class="btn btn-secondary btn-sm ml-2" id="clearSelectionBtn" disabled>
                    <i class="fas fa-times"></i> Clear Selection
                </button>
            </div>
        </div>
    }

    <!-- Orders Table -->
    <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-danger">
                Deleted Orders (@ViewBag.DeletedCount)
            </h6>
            <span class="text-muted small">
                Orders are automatically deleted after 30 days
            </span>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="trashTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="selectAllCheckbox">
                                </th>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Order Date</th>
                                <th>Deleted Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th width="200">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model)
                            {
                                <tr data-order-id="@order.OrderId">
                                    <td>
                                        <input type="checkbox" class="order-checkbox" value="@order.OrderId">
                                    </td>
                                    <td>
                                        <strong>#@order.OrderId</strong>
                                        @if (!string.IsNullOrEmpty(order.InternalReference))
                                        {
                                            <br>
                                            <small class="text-muted">Ref: @order.InternalReference</small>
                                        }
                                    </td>
                                    <td>
                                        <strong>@order.FirstName @order.LastName</strong><br>
                                        <small class="text-muted">@order.Email</small>
                                    </td>
                                    <td>
                                        <small>@order.OrderDate.ToString("MMM dd, yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        <small>@order.DeletedAt?.ToString("MMM dd, yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        <strong>@order.Total.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</strong>
                                    </td>
                                    <td>
                                        <span class="badge badge-secondary">@order.OrderStatus</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <form method="post" asp-action="Restore" asp-route-id="@order.OrderId" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-success btn-sm"
                                                        title="Restore Order"
                                                        onclick="return confirm('Restore order #@order.OrderId?');">
                                                    <i class="fas fa-undo"></i> Restore
                                                </button>
                                            </form>
                                            <button type="button" class="btn btn-danger btn-sm ml-1 permanent-delete-btn"
                                                    data-order-id="@order.OrderId" data-order-number="#@order.OrderId"
                                                    title="Delete Permanently">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-trash-alt fa-4x text-muted mb-3"></i>
                    <h4>Trash is empty</h4>
                    <p class="text-muted">No deleted orders found</p>
                    <a href="@Url.Action("Index")" class="btn btn-primary">
                        <i class="fas fa-arrow-left"></i> Back to Orders
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Permanent Delete</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="deleteModalMessage">Are you sure you want to delete this order?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Permanently</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Actions</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="bulkModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmBulkActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            let selectedOrders = [];
            let currentAction = '';
            let deleteOrderId = '';

            // Select all checkboxes
            $('#selectAllCheckbox').change(function() {
                const isChecked = this.checked;
                $('.order-checkbox').prop('checked', isChecked);
                updateSelectedOrders();
            });

            // Individual checkbox change
            $(document).on('change', '.order-checkbox', function() {
                updateSelectedOrders();
            });

            // Select All button
            $('#selectAllBtn').click(function() {
                $('.order-checkbox').prop('checked', true);
                $('#selectAllCheckbox').prop('checked', true);
                updateSelectedOrders();
            });

            // Clear selection
            $('#clearSelectionBtn').click(function() {
                $('.order-checkbox').prop('checked', false);
                $('#selectAllCheckbox').prop('checked', false);
                updateSelectedOrders();
            });

            // Update selected orders array and UI
            function updateSelectedOrders() {
                selectedOrders = [];
                $('.order-checkbox:checked').each(function() {
                    selectedOrders.push($(this).val());
                });

                const hasSelection = selectedOrders.length > 0;

                // Update button states
                $('#restoreSelectedBtn').prop('disabled', !hasSelection);
                $('#deleteSelectedBtn').prop('disabled', !hasSelection);
                $('#clearSelectionBtn').prop('disabled', !hasSelection);

                // Update button text
                if (hasSelection) {
                    $('#restoreSelectedBtn').html(`<i class="fas fa-undo"></i> Restore Selected (${selectedOrders.length})`);
                    $('#deleteSelectedBtn').html(`<i class="fas fa-trash"></i> Delete Selected (${selectedOrders.length})`);
                } else {
                    $('#restoreSelectedBtn').html('<i class="fas fa-undo"></i> Restore Selected');
                    $('#deleteSelectedBtn').html('<i class="fas fa-trash"></i> Delete Selected');
                }
            }

            // Restore selected orders
            $('#restoreSelectedBtn').click(function() {
                if (selectedOrders.length === 0) return;

                $('#bulkModalMessage').html(`Restore ${selectedOrders.length} selected order(s)?`);
                currentAction = 'restore';
                $('#confirmBulkActionBtn')
                    .removeClass('btn-danger')
                    .addClass('btn-primary')
                    .text('Restore');
                $('#bulkActionsModal').modal('show');
            });

            // Delete selected orders permanently
            $('#deleteSelectedBtn').click(function() {
                if (selectedOrders.length === 0) return;

                $('#bulkModalMessage').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning: Permanent Delete</strong><br>
                        This will permanently delete ${selectedOrders.length} selected order(s) from the database.<br>
                        <strong>This action cannot be undone!</strong>
                    </div>
                    <p>Are you absolutely sure you want to permanently delete these orders?</p>
                `);
                currentAction = 'permanent-delete';
                $('#confirmBulkActionBtn')
                    .removeClass('btn-primary')
                    .addClass('btn-danger')
                    .text('Delete Permanently');
                $('#bulkActionsModal').modal('show');
            });

            // Confirm bulk action
            $('#confirmBulkActionBtn').click(function() {
                if (currentAction === 'restore') {
                    // Create restore form
                    const form = createBulkForm('@Url.Action("BulkRestore")', selectedOrders);
                    document.body.appendChild(form);
                    form.submit();
                } else if (currentAction === 'permanent-delete') {
                    // Create permanent delete form
                    const form = createBulkForm('@Url.Action("BulkPermanentDelete")', selectedOrders);
                    document.body.appendChild(form);
                    form.submit();
                }
                $('#bulkActionsModal').modal('hide');
            });

            // Individual permanent delete button
            $(document).on('click', '.permanent-delete-btn', function() {
                const orderId = $(this).data('order-id');
                const orderNumber = $(this).data('order-number');

                $('#deleteModalMessage').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning: Permanent Delete</strong><br>
                        This will permanently delete order ${orderNumber} from the database.<br>
                        <strong>This action cannot be undone!</strong>
                    </div>
                    <p>Are you absolutely sure you want to permanently delete this order?</p>
                `);
                deleteOrderId = orderId;
                $('#confirmDeleteModal').modal('show');
            });

            // Confirm individual delete
            $('#confirmDeleteBtn').click(function() {
                // Create form for individual permanent delete
                const form = document.createElement('form');
                form.method = 'post';
                form.action = '@Url.Action("PermanentDelete")/' + deleteOrderId;

                // Add anti-forgery token
                const token = $('input[name="__RequestVerificationToken"]').val();
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token;
                form.appendChild(tokenInput);

                document.body.appendChild(form);
                form.submit();
            });

            // Helper function to create bulk action forms
            function createBulkForm(actionUrl, orderIds) {
                const form = document.createElement('form');
                form.method = 'post';
                form.action = actionUrl;

                // Add anti-forgery token
                const token = $('input[name="__RequestVerificationToken"]').val();
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token;
                form.appendChild(tokenInput);

                // Add order IDs
                orderIds.forEach(id => {
                    const orderIdInput = document.createElement('input');
                    orderIdInput.type = 'hidden';
                    orderIdInput.name = 'orderIds';
                    orderIdInput.value = id;
                    form.appendChild(orderIdInput);
                });

                return form;
            }

            // Show alerts
            @if (TempData["SuccessMessage"] != null)
            {
                        <text>
                        showAlert('@TempData["SuccessMessage"]', 'success');
                        </text>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                        <text>
                        showAlert('@TempData["ErrorMessage"]', 'error');
                        </text>
            }

            function showAlert(message, type = 'success') {
                const alertClass = type === 'success' ? 'alert-success' :
                                 type === 'error' ? 'alert-danger' : 'alert-info';

                const alertHtml = `
                    <div class="alert ${alertClass} alert-dismissible fade show fixed-top m-3" role="alert">
                        ${message}
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>
                `;

                $('body').append(alertHtml);
                setTimeout(() => $('.alert').alert('close'), 5000);
            }

            // Initialize DataTable for better sorting and filtering
            $('#trashTable').DataTable({
                "pageLength": 25,
                "order": [[4, 'desc']], // Sort by deletion date by default
                "language": {
                    "search": "Search:",
                    "lengthMenu": "Show _MENU_ orders",
                    "info": "Showing _START_ to _END_ of _TOTAL_ deleted orders",
                    "infoEmpty": "Showing 0 to 0 of 0 orders",
                    "infoFiltered": "(filtered from _MAX_ total deleted orders)",
                    "zeroRecords": "No matching deleted orders found"
                },
                "columnDefs": [
                    { "orderable": false, "targets": [0, 7] } // Disable sorting for checkbox and action columns
                ]
            });

            // Keyboard shortcuts
            $(document).keydown(function(e) {
                // Ctrl + A to select all
                if (e.ctrlKey && e.key === 'a') {
                    e.preventDefault();
                    $('#selectAllBtn').click();
                }

                // Escape to clear selection
                if (e.key === 'Escape') {
                    $('#clearSelectionBtn').click();
                }

                // Delete key to delete permanently
                if (e.key === 'Delete' && selectedOrders.length > 0) {
                    e.preventDefault();
                    $('#deleteSelectedBtn').click();
                }
            });

            // Add loading indicator for forms
            $(document).on('submit', 'form', function() {
                const $btn = $(this).find('button[type="submit"]');
                if ($btn.length) {
                    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');
                }
            });
        });
    </script>
}