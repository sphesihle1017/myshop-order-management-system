@model MyShop.Models.Checkout

@{
    ViewData["Title"] = "Order Details";
    ViewData["ActivePage"] = "Orders";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Order #@Model.OrderId</h1>
        <div class="btn-group">
            <a href="@Url.Action("Edit", new { id = Model.OrderId })" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit Order
            </a>
            <a href="@Url.Action("Print", new { id = Model.OrderId })" class="btn btn-secondary" target="_blank">
                <i class="fas fa-print"></i> Print
            </a>
            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Orders
            </a>
        </div>
    </div>

    <!-- Order Status Banner -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="mr-3">
                                    <div class="rounded-circle bg-@(GetStatusColor(Model.OrderStatus)) p-3">
                                        <i class="fas fa-shopping-cart fa-2x text-white"></i>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="mb-0">Order Status</h5>
                                    <span class="badge badge-@GetStatusBadgeColor(Model.OrderStatus) badge-lg">
                                        @Model.OrderStatus
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="mr-3">
                                    <div class="rounded-circle bg-@(GetPaymentColor(Model.PaymentStatus)) p-3">
                                        <i class="fas fa-credit-card fa-2x text-white"></i>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="mb-0">Payment</h5>
                                    <span class="badge badge-@GetPaymentBadgeColor(Model.PaymentStatus) badge-lg">
                                        @Model.PaymentStatus
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="mr-3">
                                    <div class="rounded-circle bg-info p-3">
                                        <i class="fas fa-calendar fa-2x text-white"></i>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="mb-0">Order Date</h5>
                                    <p class="mb-0">@Model.OrderDate.ToString("MMMM dd, yyyy HH:mm")</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="mr-3">
                                    <div class="rounded-circle bg-success p-3">
                                        <i class="fas fa-dollar-sign fa-2x text-white"></i>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="mb-0">Total Amount</h5>
                                    <h3 class="mb-0 text-success">@Model.Total.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Customer & Shipping -->
        <div class="col-lg-4">
            <!-- Customer Information -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-user mr-2"></i>Customer Information
                    </h6>
                </div>
                <div class="card-body">
                    <h5 class="font-weight-bold">@Model.FirstName @Model.LastName</h5>
                    <p class="mb-1">
                        <i class="fas fa-envelope mr-2 text-muted"></i>
                        <a href="mailto:@Model.Email">@Model.Email</a>
                    </p>
                    <p class="mb-3">
                        <i class="fas fa-phone mr-2 text-muted"></i>
                        @Model.Phone
                    </p>

                    <h6 class="font-weight-bold mt-4">
                        <i class="fas fa-map-marker-alt mr-2"></i>Shipping Address
                    </h6>
                    <p class="mb-1">@Model.Address</p>
                    <p class="mb-1">@Model.City, @Model.PostalCode</p>
                    <p class="mb-0">@Model.Country</p>
                </div>
            </div>

            <!-- Order Information -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle mr-2"></i>Order Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p class="mb-2"><strong>Order ID</strong></p>
                            <p class="mb-2"><strong>Priority</strong></p>
                            <p class="mb-2"><strong>Assigned To</strong></p>
                            <p class="mb-2"><strong>Payment Method</strong></p>
                        </div>
                        <div class="col-6">
                            <p class="mb-2">#@Model.OrderId</p>
                            <p class="mb-2">
                                <span class="badge badge-@GetPriorityBadgeColor(Model.Priority)">
                                    @Model.Priority
                                </span>
                            </p>
                            <p class="mb-2">@(Model.AssignedTo ?? "Not Assigned")</p>
                            <p class="mb-2">@Model.PaymentMethod</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shipping Information -->
            @if (!string.IsNullOrEmpty(Model.TrackingNumber) || !string.IsNullOrEmpty(Model.ShippingCarrier))
            {
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-shipping-fast mr-2"></i>Shipping Information
                        </h6>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(Model.TrackingNumber))
                        {
                            <p class="mb-2"><strong>Tracking Number:</strong></p>
                            <p class="mb-3">
                                <code>@Model.TrackingNumber</code>
                                @if (!string.IsNullOrEmpty(Model.ShippingCarrier))
                                {
                                    <br>
                                    <small class="text-muted">via @Model.ShippingCarrier</small>
                                }
                            </p>
                        }

                        @if (Model.EstimatedDelivery.HasValue)
                        {
                            <p class="mb-1"><strong>Estimated Delivery:</strong></p>
                            <p class="mb-3">@Model.EstimatedDelivery.Value.ToString("MMMM dd, yyyy")</p>
                        }

                        @if (Model.ActualDelivery.HasValue)
                        {
                            <p class="mb-1"><strong>Delivered On:</strong></p>
                            <p class="mb-0">@Model.ActualDelivery.Value.ToString("MMMM dd, yyyy HH:mm")</p>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Right Column: Order Items & Summary -->
        <div class="col-lg-8">
            <!-- Order Items -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-shopping-bag mr-2"></i>Order Items
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="thead-light">
                                <tr>
                                    <th>Product</th>
                                    <th width="100" class="text-center">Quantity</th>
                                    <th width="120" class="text-right">Price</th>
                                    <th width="120" class="text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.OrderItems != null && Model.OrderItems.Any())
                                {
                                    foreach (var item in Model.OrderItems)
                                    {
                                        <tr>
                                            <td>
                                                <strong>@item.ProductName</strong>
                                                <br>
                                                <small class="text-muted">Product ID: @item.ProductId</small>
                                            </td>
                                            <td class="text-center">@item.Quantity</td>
                                            <td class="text-right">@item.Price.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</td>
                                            <td class="text-right font-weight-bold">@item.Total.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center py-4">
                                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">No items found for this order</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-receipt mr-2"></i>Order Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            @if (!string.IsNullOrEmpty(Model.AdminNotes))
                            {
                                <h6 class="font-weight-bold mb-2">Admin Notes:</h6>
                                <div class="alert alert-info">
                                    @Model.AdminNotes
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(Model.InternalReference))
                            {
                                <p class="mb-2"><strong>Internal Reference:</strong> @Model.InternalReference</p>
                            }

                            @if (!string.IsNullOrEmpty(Model.MarketingSource))
                            {
                                <p class="mb-0"><strong>Marketing Source:</strong> @Model.MarketingSource</p>
                            }
                        </div>
                        <div class="col-md-4">
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Subtotal:</strong></td>
                                    <td class="text-right">@Model.Subtotal.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</td>
                                </tr>
                                @if (Model.ShippingCost > 0)
                                {
                                    <tr>
                                        <td><strong>Shipping:</strong></td>
                                        <td class="text-right">@Model.ShippingCost.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</td>
                                    </tr>
                                }
                                @if (Model.Tax > 0)
                                {
                                    <tr>
                                        <td><strong>Tax:</strong></td>
                                        <td class="text-right">@Model.Tax.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</td>
                                    </tr>
                                }
                                @if (Model.Discount > 0)
                                {
                                    <tr>
                                        <td><strong>Discount:</strong></td>
                                        <td class="text-right text-danger">-@Model.Discount.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</td>
                                    </tr>
                                }
                                <tr class="table-active">
                                    <td><strong>Total:</strong></td>
                                    <td class="text-right font-weight-bold text-success">@Model.Total.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-bolt mr-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <form method="post" asp-action="Edit" asp-route-id="@Model.OrderId">
                                <input type="hidden" name="actionType" value="mark-processing">
                                <button type="submit" class="btn btn-info btn-block" @(Model.OrderStatus == "Processing" ? "disabled" : "")>
                                    <i class="fas fa-cogs"></i> Processing
                                </button>
                            </form>
                        </div>
                        <div class="col-md-3 mb-3">
                            <form method="post" asp-action="Edit" asp-route-id="@Model.OrderId">
                                <input type="hidden" name="actionType" value="mark-shipped">
                                <button type="submit" class="btn btn-primary btn-block" @(Model.OrderStatus == "Shipped" ? "disabled" : "")>
                                    <i class="fas fa-shipping-fast"></i> Shipped
                                </button>
                            </form>
                        </div>
                        <div class="col-md-3 mb-3">
                            <form method="post" asp-action="Edit" asp-route-id="@Model.OrderId">
                                <input type="hidden" name="actionType" value="mark-delivered">
                                <button type="submit" class="btn btn-success btn-block" @(Model.OrderStatus == "Delivered" ? "disabled" : "")>
                                    <i class="fas fa-truck"></i> Delivered
                                </button>
                            </form>
                        </div>
                        <div class="col-md-3 mb-3">
                            <form method="post" asp-action="Edit" asp-route-id="@Model.OrderId">
                                <input type="hidden" name="actionType" value="mark-paid">
                                <button type="submit" class="btn btn-success btn-block" @(Model.PaymentStatus == "Paid" ? "disabled" : "")>
                                    <i class="fas fa-check-circle"></i> Paid
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Confirm quick actions
            $('form[action*="Edit"]').on('submit', function(e) {
                const actionType = $(this).find('input[name="actionType"]').val();
                const orderId = @Model.OrderId;

                if (actionType) {
                    const actionText = actionType.replace('mark-', '').replace('-', ' ');
                    if (!confirm(`Are you sure you want to mark order #${orderId} as ${actionText}?`)) {
                        e.preventDefault();
                        return false;
                    }
                }
                return true;
            });
        });
    </script>
}

@functions {
    private string GetStatusBadgeColor(string status)
    {
        return status switch
        {
            "Pending" => "warning",
            "Processing" => "info",
            "Shipped" => "primary",
            "Delivered" => "success",
            "Cancelled" => "danger",
            "Refunded" => "secondary",
            "On Hold" => "dark",
            _ => "secondary"
        };
    }

    private string GetPaymentBadgeColor(string paymentStatus)
    {
        return paymentStatus switch
        {
            "Paid" => "success",
            "Pending" => "warning",
            "Failed" => "danger",
            "Refunded" => "info",
            "Partially Refunded" => "info",
            _ => "secondary"
        };
    }

    private string GetPriorityBadgeColor(string priority)
    {
        return priority switch
        {
            "Low" => "secondary",
            "Normal" => "info",
            "High" => "warning",
            "Urgent" => "danger",
            _ => "secondary"
        };
    }

    private string GetStatusColor(string status)
    {
        return status switch
        {
            "Pending" => "warning",
            "Processing" => "info",
            "Shipped" => "primary",
            "Delivered" => "success",
            _ => "secondary"
        };
    }

    private string GetPaymentColor(string paymentStatus)
    {
        return paymentStatus switch
        {
            "Paid" => "success",
            "Pending" => "warning",
            "Failed" => "danger",
            _ => "secondary"
        };
    }
}