@model IEnumerable<MyShop.Models.Checkout>

@{
    ViewData["Title"] = "Order Management";
    ViewData["ActivePage"] = "Orders";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Order Management</h1>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown">
                <i class="fas fa-download"></i> Export
            </button>
            <div class="dropdown-menu">
                <a class="dropdown-item" href="@Url.Action("Export", new { format = "csv" })">
                    <i class="fas fa-file-csv"></i> Export as CSV
                </a>
                <a class="dropdown-item" href="@Url.Action("Export", new { format = "excel" })">
                    <i class="fas fa-file-excel"></i> Export as Excel
                </a>
            </div>
            <a href="@Url.Action("Dashboard")" class="btn btn-outline-info">
                <i class="fas fa-chart-bar"></i> Dashboard
            </a>
            <a href="@Url.Action("Trash")" class="btn btn-outline-danger ml-2">
                <i class="fas fa-trash-alt"></i> Trash (@ViewBag.DeletedOrders)
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Orders</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.TotalOrders</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Revenue</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @ViewBag.TotalRevenue.ToString("C", new System.Globalization.CultureInfo("en-ZA"))
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pending</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.PendingOrders</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Processing</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.ProcessingOrders</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-cogs fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Shipped</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.ShippedOrders</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shipping-fast fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Delivered</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.DeliveredOrders</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-truck fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Filters & Search</h6>
        </div>
        <div class="card-body">
            <form method="get" class="form-inline" id="filterForm">
                @Html.AntiForgeryToken()
                <div class="input-group mb-2 mr-sm-2" style="width: 300px;">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                    </div>
                    <input type="text" class="form-control" name="search" placeholder="Search orders..." value="@ViewBag.SearchTerm">
                </div>

                <select class="form-control mb-2 mr-sm-2" name="status" id="statusFilter">
                    <option value="all" selected="@(ViewBag.CurrentStatus == "all")">All Statuses</option>
                    <option value="Pending" selected="@(ViewBag.CurrentStatus == "Pending")">Pending</option>
                    <option value="Processing" selected="@(ViewBag.CurrentStatus == "Processing")">Processing</option>
                    <option value="Shipped" selected="@(ViewBag.CurrentStatus == "Shipped")">Shipped</option>
                    <option value="Delivered" selected="@(ViewBag.CurrentStatus == "Delivered")">Delivered</option>
                    <option value="Cancelled" selected="@(ViewBag.CurrentStatus == "Cancelled")">Cancelled</option>
                    <option value="On Hold" selected="@(ViewBag.CurrentStatus == "On Hold")">On Hold</option>
                    <option value="Refunded" selected="@(ViewBag.CurrentStatus == "Refunded")">Refunded</option>
                </select>

                <select class="form-control mb-2 mr-sm-2" name="sort" id="sortFilter">
                    <option value="newest" selected="@(ViewBag.CurrentSort == "newest")">Newest First</option>
                    <option value="oldest" selected="@(ViewBag.CurrentSort == "oldest")">Oldest First</option>
                    <option value="price-high" selected="@(ViewBag.CurrentSort == "price-high")">Price: High to Low</option>
                    <option value="price-low" selected="@(ViewBag.CurrentSort == "price-low")">Price: Low to High</option>
                    <option value="name" selected="@(ViewBag.CurrentSort == "name")">Customer Name</option>
                    <option value="total-high" selected="@(ViewBag.CurrentSort == "total-high")">Total: High to Low</option>
                    <option value="total-low" selected="@(ViewBag.CurrentSort == "total-low")">Total: Low to High</option>
                </select>

                <div class="input-group mb-2 mr-sm-2">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                    </div>
                    <input type="date" class="form-control" name="startDate" id="startDate" value="@Context.Request.Query["startDate"]">
                    <input type="date" class="form-control" name="endDate" id="endDate" value="@Context.Request.Query["endDate"]">
                </div>

                <div class="form-check mb-2 mr-sm-2">
                    <input class="form-check-input" type="checkbox" id="showDeleted" name="showDeleted"
                           value="true" @(ViewBag.ShowDeleted ? "checked" : "")>
                    <label class="form-check-label" for="showDeleted">
                        Show Deleted Orders
                    </label>
                </div>

                <button type="submit" class="btn btn-primary mb-2">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button type="button" class="btn btn-secondary mb-2 ml-2" id="clearFiltersBtn">
                    <i class="fas fa-times"></i> Clear
                </button>
            </form>
        </div>
    </div>

    <!-- Quick Action Buttons -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
            <div>
                <button type="button" class="btn btn-outline-primary btn-sm" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2 mb-3">
                <!-- Bulk Action Forms -->
                <form method="post" asp-action="BulkAction" id="bulkProcessingForm" class="d-inline">
                    <input type="hidden" name="action" value="mark-processing">
                    <button type="submit" class="btn btn-info btn-sm" id="processSelectedBtn" disabled>
                        <i class="fas fa-cogs"></i> Process Selected
                    </button>
                </form>

                <form method="post" asp-action="BulkAction" id="bulkShippedForm" class="d-inline">
                    <input type="hidden" name="action" value="mark-shipped">
                    <button type="submit" class="btn btn-primary btn-sm" id="shipSelectedBtn" disabled>
                        <i class="fas fa-shipping-fast"></i> Ship Selected
                    </button>
                </form>

                <form method="post" asp-action="BulkAction" id="bulkDeliveredForm" class="d-inline">
                    <input type="hidden" name="action" value="mark-delivered">
                    <button type="submit" class="btn btn-success btn-sm" id="deliverSelectedBtn" disabled>
                        <i class="fas fa-truck"></i> Deliver Selected
                    </button>
                </form>

                <form method="post" asp-action="BulkAction" id="bulkPaidForm" class="d-inline">
                    <input type="hidden" name="action" value="mark-paid">
                    <button type="submit" class="btn btn-success btn-sm" id="paySelectedBtn" disabled>
                        <i class="fas fa-check-circle"></i> Mark Paid
                    </button>
                </form>

                <form method="post" asp-action="BulkAction" id="bulkAssignForm" class="d-inline">
                    <input type="hidden" name="action" value="assign-me">
                    <button type="submit" class="btn btn-warning btn-sm" id="assignSelectedBtn" disabled>
                        <i class="fas fa-user-check"></i> Assign to Me
                    </button>
                </form>

                <form method="post" asp-action="BulkAction" id="bulkSoftDeleteForm" class="d-inline">
                    <input type="hidden" name="action" value="soft-delete">
                    <button type="submit" class="btn btn-danger btn-sm" id="softDeleteSelectedBtn" disabled>
                        <i class="fas fa-trash"></i> Move to Trash
                    </button>
                </form>

                <form method="post" asp-action="BulkRestore" id="bulkRestoreForm" class="d-inline @(ViewBag.ShowDeleted ? "" : "d-none")">
                    <input type="hidden" name="orderIds" id="restoreOrderIds">
                    <button type="submit" class="btn btn-success btn-sm" id="restoreSelectedBtn" disabled>
                        <i class="fas fa-undo"></i> Restore Selected
                    </button>
                </form>

                <button type="button" class="btn btn-secondary btn-sm" id="exportSelectedBtn" disabled>
                    <i class="fas fa-download"></i> Export Selected
                </button>

                <button type="button" class="btn btn-danger btn-sm" id="clearSelectionBtn" disabled>
                    <i class="fas fa-times"></i> Clear Selection
                </button>
            </div>

            <!-- Selection Counter -->
            <div id="selectionCounter" class="d-none">
                <span class="badge badge-primary" id="selectedCount">0</span> orders selected
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                @(ViewBag.ShowDeleted ? "Deleted Orders" : "Active Orders")
            </h6>
            <div class="d-flex align-items-center">
                <span class="mr-3 text-muted small" id="orderCount">
                    Showing @Model.Count() orders
                </span>
                <div class="input-group" style="width: 300px;">
                    <select class="form-control" id="bulkActionSelect">
                        <option value="">Bulk Actions</option>
                        @if (!ViewBag.ShowDeleted)
                        {
                            <option value="mark-processing">Mark as Processing</option>
                            <option value="mark-shipped">Mark as Shipped</option>
                            <option value="mark-delivered">Mark as Delivered</option>
                            <option value="mark-paid">Mark as Paid</option>
                            <option value="assign-me">Assign to Me</option>
                            <option value="soft-delete">Move to Trash</option>
                        }
                        else
                        {
                            <option value="restore">Restore Selected</option>
                            <option value="permanent-delete">Delete Permanently</option>
                        }
                        <option value="export-selected">Export Selected</option>
                    </select>
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-primary" id="applyBulkActionBtn" disabled>
                            Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="ordersTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th>Order ID</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Payment</th>
                                <th>Tracking</th>
                                @if (!ViewBag.ShowDeleted)
                                {
                                    <th width="250">Quick Actions</th>
                                }
                                <th width="150">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model)
                            {
                                <tr data-order-id="@order.OrderId" data-status="@order.OrderStatus" data-payment="@order.PaymentStatus"
                                    class="@(order.IsDeleted ? "table-danger" : "")">
                                    <td>
                                        <input type="checkbox" name="orderIds" value="@order.OrderId" class="order-checkbox">
                                    </td>
                                    <td>
                                        <strong>
                                            <a href="@Url.Action("Details", new { id = order.OrderId })"
                                               class="text-primary @(order.IsDeleted ? "text-muted" : "")">
                                                #@order.OrderId
                                            </a>
                                        </strong>
                                        @if (!string.IsNullOrEmpty(order.InternalReference))
                                        {
                                            <br>
                                            <small class="text-muted">Ref: @order.InternalReference</small>
                                        }
                                        @if (order.IsDeleted)
                                        {
                                            <br>
                                            <small class="text-danger">
                                                <i class="fas fa-trash"></i> Deleted on @order.DeletedAt?.ToString("MMM dd, yyyy")
                                            </small>
                                        }
                                    </td>
                                    <td>
                                        <small>@order.OrderDate.ToString("MMM dd, yyyy")</small><br>
                                        <small class="text-muted">@order.OrderDate.ToString("HH:mm")</small>
                                    </td>
                                    <td>
                                        <strong>@order.FirstName @order.LastName</strong>
                                        <br>
                                        <small class="text-muted">@order.Email</small>
                                        <br>
                                        <small class="text-muted">@order.Phone</small>
                                        @if (!string.IsNullOrEmpty(order.AssignedTo))
                                        {
                                            <br>
                                            <small class="text-info">
                                                <i class="fas fa-user"></i> @order.AssignedTo
                                            </small>
                                        }
                                    </td>
                                    <td>
                                        <strong>@order.Total.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</strong>
                                        @if (order.ShippingCost > 0)
                                        {
                                            <br>
                                            <small class="text-muted">Shipping: @order.ShippingCost.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</small>
                                        }
                                        @if (order.Discount > 0)
                                        {
                                            <br>
                                            <small class="text-success">Discount: @order.Discount.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</small>

                                        }
                                    </td>
                                    <td>
                                        <span class="badge badge-@GetStatusBadgeColor(order.OrderStatus)">
                                            @order.OrderStatus
                                        </span>
                                        @if (order.Priority == "High")
                                        {
                                            <br>
                                            <span class="badge badge-danger">High Priority</span>
                                        }
                                        else if (order.Priority == "Urgent")
                                        {
                                            <br>
                                            <span class="badge badge-dark">Urgent</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge badge-@GetPaymentBadgeColor(order.PaymentStatus)">
                                            @order.PaymentStatus
                                        </span>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(order.TrackingNumber))
                                        {
                                            <a href="#" class="tracking-link text-primary" data-tracking="@order.TrackingNumber" data-carrier="@order.ShippingCarrier">
                                                @order.TrackingNumber
                                            </a>
                                            @if (!string.IsNullOrEmpty(order.ShippingCarrier))
                                            {
                                                <br>
                                                <small class="text-muted">via @order.ShippingCarrier</small>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">No tracking</span>
                                        }
                                    </td>
                                    @if (!ViewBag.ShowDeleted)
                                    {
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                @if (order.OrderStatus == "Pending" || order.OrderStatus == "On Hold")
                                                {
                                                    <form method="post" asp-action="Edit" asp-route-id="@order.OrderId" class="d-inline">
                                                        <input type="hidden" name="actionType" value="mark-processing">
                                                        <button type="submit" class="btn btn-info btn-sm" title="Start Processing">
                                                            <i class="fas fa-cogs"></i> Process
                                                        </button>
                                                    </form>
                                                }
                                                @if (order.OrderStatus == "Processing")
                                                {
                                                    <form method="post" asp-action="Edit" asp-route-id="@order.OrderId" class="d-inline">
                                                        <input type="hidden" name="actionType" value="mark-shipped">
                                                        <button type="submit" class="btn btn-primary btn-sm" title="Mark as Shipped">
                                                            <i class="fas fa-shipping-fast"></i> Ship
                                                        </button>
                                                    </form>
                                                }
                                                @if (order.OrderStatus == "Shipped")
                                                {
                                                    <form method="post" asp-action="Edit" asp-route-id="@order.OrderId" class="d-inline">
                                                        <input type="hidden" name="actionType" value="mark-delivered">
                                                        <button type="submit" class="btn btn-success btn-sm" title="Mark as Delivered">
                                                            <i class="fas fa-truck"></i> Deliver
                                                        </button>
                                                    </form>
                                                }
                                                @if (order.PaymentStatus != "Paid")
                                                {
                                                    <form method="post" asp-action="Edit" asp-route-id="@order.OrderId" class="d-inline">
                                                        <input type="hidden" name="actionType" value="mark-paid">
                                                        <button type="submit" class="btn btn-success btn-sm" title="Mark as Paid">
                                                            <i class="fas fa-check-circle"></i> Paid
                                                        </button>
                                                    </form>
                                                }
                                                @if (order.Priority != "High" && order.OrderStatus != "Cancelled" && order.OrderStatus != "Delivered")
                                                {
                                                    <form method="post" asp-action="Edit" asp-route-id="@order.OrderId" class="d-inline">
                                                        <input type="hidden" name="actionType" value="set-high-priority">
                                                        <button type="submit" class="btn btn-warning btn-sm" title="Set High Priority">
                                                            <i class="fas fa-exclamation"></i>
                                                        </button>
                                                    </form>
                                                }
                                            </div>
                                        </td>
                                    }
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            @if (!order.IsDeleted)
                                            {
                                                <a href="@Url.Action("Details", new { id = order.OrderId })"
                                                   class="btn btn-info" title="View Details" data-toggle="tooltip">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="@Url.Action("Edit", new { id = order.OrderId })"
                                                   class="btn btn-primary" title="Edit Order" data-toggle="tooltip">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                            }
                                            <button type="button" class="btn btn-secondary dropdown-toggle"
                                                    data-toggle="dropdown" title="More Actions">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <div class="dropdown-menu">
                                                @if (!order.IsDeleted)
                                                {
                                                    <a href="@Url.Action("Print", new { id = order.OrderId })"
                                                       class="dropdown-item" target="_blank">
                                                        <i class="fas fa-print text-secondary"></i> Print Order
                                                    </a>
                                                    @if (!string.IsNullOrEmpty(order.TrackingNumber))
                                                    {
                                                        <form method="post" asp-action="Edit" asp-route-id="@order.OrderId"
                                                              style="display: inline;">
                                                            <input type="hidden" name="actionType" value="send-tracking">
                                                            <button type="submit" class="dropdown-item">
                                                                <i class="fas fa-envelope text-warning"></i> Send Tracking
                                                            </button>
                                                        </form>
                                                    }
                                                    <form method="post" asp-action="Edit" asp-route-id="@order.OrderId"
                                                          style="display: inline;">
                                                        <input type="hidden" name="actionType" value="generate-invoice">
                                                        <button type="submit" class="dropdown-item">
                                                            <i class="fas fa-file-invoice-dollar text-primary"></i> Generate Invoice
                                                        </button>
                                                    </form>
                                                    @if (order.OrderStatus != "On Hold")
                                                    {
                                                        <form method="post" asp-action="Edit" asp-route-id="@order.OrderId"
                                                              style="display: inline;">
                                                            <input type="hidden" name="actionType" value="put-on-hold">
                                                            <button type="submit" class="dropdown-item">
                                                                <i class="fas fa-pause text-warning"></i> Put on Hold
                                                            </button>
                                                        </form>
                                                    }
                                                    <div class="dropdown-divider"></div>
                                                }
                                                @if (!order.IsDeleted)
                                                {
                                                    <a href="@Url.Action("Delete", new { id = order.OrderId })"
                                                       class="dropdown-item text-danger">
                                                        <i class="fas fa-trash-alt"></i> Move to Trash
                                                    </a>
                                                }
                                                else
                                                {
                                                    <form method="post" asp-action="Restore" asp-route-id="@order.OrderId"
                                                          style="display: inline;">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="dropdown-item text-success">
                                                            <i class="fas fa-undo"></i> Restore Order
                                                        </button>
                                                    </form>
                                                    <a href="@Url.Action("PermanentDelete", new { id = order.OrderId })"
                                                       class="dropdown-item text-danger">
                                                        <i class="fas fa-trash"></i> Delete Permanently
                                                    </a>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div>
                        <span class="text-muted">
                            Showing <strong>@Model.Count()</strong> of <strong>@ViewBag.TotalOrders</strong> @(ViewBag.ShowDeleted ? "deleted" : "active") orders
                        </span>
                    </div>
                    <nav>
                        <ul class="pagination mb-0">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                    <h4>No orders found</h4>
                    <p class="text-muted">Try adjusting your filters or search criteria</p>
                    <a href="@Url.Action("Index")" class="btn btn-primary">
                        <i class="fas fa-times"></i> Clear Filters
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Tracking Modal -->
<div class="modal fade" id="trackingModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tracking Information</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>Tracking Number:</strong> <span id="trackingNumber"></span></p>
                <p><strong>Carrier:</strong> <span id="trackingCarrier"></span></p>
                <div class="form-group">
                    <label for="trackingUrl">Tracking URL:</label>
                    <input type="text" class="form-control" id="trackingUrl" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="openTrackingBtn">
                    <i class="fas fa-external-link-alt"></i> Open Tracking
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="deleteModalMessage">Are you sure you want to delete this order?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
            $(document).ready(function() {
                // Initialize tooltips
                $('[data-toggle="tooltip"]').tooltip();

                // Store selected order IDs
                let selectedOrders = [];
                let deleteFormUrl = '';
                let isPermanentDelete = false;

                // Select all checkboxes
                $('#selectAll').change(function() {
                    const isChecked = this.checked;
                    $('.order-checkbox').prop('checked', isChecked);
                    updateSelectionState();
                });

                // Update selection state when individual checkboxes change
                $('.order-checkbox').change(function() {
                    updateSelectionState();
                });

                // Update selection counter and button states
                function updateSelectionState() {
                    selectedOrders = [];
                    $('.order-checkbox:checked').each(function() {
                        selectedOrders.push($(this).val());
                    });

                    const selectedCount = selectedOrders.length;
                    const isAnySelected = selectedCount > 0;
                    const isAllSelected = selectedCount === $('.order-checkbox').length;

                    // Update select all checkbox
                    $('#selectAll').prop('checked', isAllSelected);

                    // Update counter
                    if (isAnySelected) {
                        $('#selectionCounter').removeClass('d-none');
                        $('#selectedCount').text(selectedCount);
                    } else {
                        $('#selectionCounter').addClass('d-none');
                    }

                    // Enable/disable buttons
                    const buttons = [
                        '#processSelectedBtn', '#shipSelectedBtn', '#deliverSelectedBtn',
                        '#paySelectedBtn', '#assignSelectedBtn', '#exportSelectedBtn',
                        '#clearSelectionBtn', '#applyBulkActionBtn'
                    ];

                    buttons.forEach(btn => {
                        $(btn).prop('disabled', !isAnySelected);
                    });

                    // Show/hide soft delete/restore buttons based on view mode
                    if ('@ViewBag.ShowDeleted' === 'True') {
                        $('#softDeleteSelectedBtn').hide();
                        $('#restoreSelectedBtn').show().prop('disabled', !isAnySelected);
                    } else {
                        $('#softDeleteSelectedBtn').show().prop('disabled', !isAnySelected);
                        $('#restoreSelectedBtn').hide();
                    }

                    // Show order count
                    $('#orderCount').text(`Showing ${$('.order-checkbox').length} orders, ${selectedCount} selected`);
                }


                // Clear selection
                $('#clearSelectionBtn').click(function() {
                    $('.order-checkbox').prop('checked', false);
                    $('#selectAll').prop('checked', false);
                    updateSelectionState();
                });

                // Bulk action handlers
                function submitBulkAction(action) {
                    if (selectedOrders.length === 0) {
                        showAlert('Please select at least one order', 'warning');
                        return;
                    }

                    let actionText = '';
                    let confirmMessage = '';

                    switch (action) {
                        case 'soft-delete':
                            actionText = 'move to trash';
                            confirmMessage = `Move ${selectedOrders.length} selected order(s) to trash?`;
                            break;
                        case 'restore':
                            actionText = 'restore';
                            confirmMessage = `Restore ${selectedOrders.length} selected order(s)?`;
                            break;
                        case 'permanent-delete':
                            actionText = 'permanently delete';
                            confirmMessage = `Permanently delete ${selectedOrders.length} selected order(s)? This action cannot be undone!`;
                            break;
                        case 'export-selected':
                            exportSelectedOrders(selectedOrders);
                            return;
                        default:
                            actionText = action.replace('mark-', '').replace('-', ' ');
                            confirmMessage = `Are you sure you want to ${actionText} ${selectedOrders.length} selected order(s)?`;
                    }

                    if (!confirm(confirmMessage)) {
                        return;
                    }

                    // Create form for bulk action
                    const form = document.createElement('form');
                    form.method = 'post';

                    // Set correct action URL
                    if (action === 'restore') {
                        form.action = '@Url.Action("BulkRestore")';
                    } else if (action === 'permanent-delete') {
                        form.action = '@Url.Action("BulkPermanentDelete")';
                    } else {
                        form.action = '@Url.Action("BulkAction")';
                    }

                    // Add anti-forgery token
                    const token = $('input[name="__RequestVerificationToken"]').val();
                    const tokenInput = document.createElement('input');
                    tokenInput.type = 'hidden';
                    tokenInput.name = '__RequestVerificationToken';
                    tokenInput.value = token;
                    form.appendChild(tokenInput);

                    // Add action for BulkAction only
                    if (action !== 'restore' && action !== 'permanent-delete') {
                        const actionInput = document.createElement('input');
                        actionInput.type = 'hidden';
                        actionInput.name = 'action';
                        actionInput.value = action;
                        form.appendChild(actionInput);
                    }

                    // Add order IDs
                    selectedOrders.forEach(id => {
                        const orderIdInput = document.createElement('input');
                        orderIdInput.type = 'hidden';
                        orderIdInput.name = 'orderIds';
                        orderIdInput.value = id;
                        form.appendChild(orderIdInput);
                    });

                    document.body.appendChild(form);
                    form.submit();
                }

                // Individual bulk action buttons
                $('#processSelectedBtn').click(function(e) {
                    e.preventDefault();
                    submitBulkAction('mark-processing');
                });

                $('#shipSelectedBtn').click(function(e) {
                    e.preventDefault();
                    submitBulkAction('mark-shipped');
                });

                $('#deliverSelectedBtn').click(function(e) {
                    e.preventDefault();
                    submitBulkAction('mark-delivered');
                });

                $('#paySelectedBtn').click(function(e) {
                    e.preventDefault();
                    submitBulkAction('mark-paid');
                });

                $('#assignSelectedBtn').click(function(e) {
                    e.preventDefault();
                    submitBulkAction('assign-me');
                });

                $('#softDeleteSelectedBtn').click(function(e) {
                    e.preventDefault();
                    submitBulkAction('soft-delete');
                });

                $('#restoreSelectedBtn').click(function(e) {
                    e.preventDefault();
                    submitBulkAction('restore');
                });

                $('#exportSelectedBtn').click(function() {
                    exportSelectedOrders(selectedOrders);
                });

                // Bulk action dropdown
                $('#applyBulkActionBtn').click(function() {
                    const action = $('#bulkActionSelect').val();
                    if (action) {
                        submitBulkAction(action);
                    }
                });

                // Quick action forms
                $('form[action*="Edit"]').on('submit', function(e) {
                    const actionType = $(this).find('input[name="actionType"]').val();
                    const orderId = $(this).attr('action').split('/').pop();

                    if (actionType && actionType !== 'save') {
                        const actionText = actionType.replace('mark-', '').replace('set-', '').replace('put-', '').replace('-', ' ');
                        if (!confirm(`Are you sure you want to ${actionText} order #${orderId}?`)) {
                            e.preventDefault();
                            return false;
                        }
                    }
                    return true;
                });

                // Handle delete confirmation
                $('a[href*="Delete"]').click(function(e) {
                    e.preventDefault();
                    const url = $(this).attr('href');
                    const orderId = url.split('/').pop();

                    // Check if it's a permanent delete or soft delete
                    isPermanentDelete = url.includes('PermanentDelete');

                    if (isPermanentDelete) {
                        $('#deleteModalMessage').html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Warning: Permanent Delete</strong><br>
                                This will permanently delete order #${orderId} from the database.<br>
                                <strong>This action cannot be undone!</strong>
                            </div>
                            <p>Are you absolutely sure you want to permanently delete this order?</p>
                        `);
                    } else {
                        $('#deleteModalMessage').text(`Move order #${orderId} to trash? You can restore it later from the trash.`);
                    }

                    deleteFormUrl = url;
                    $('#confirmDeleteModal').modal('show');
                });

                // Confirm delete button
                $('#confirmDeleteBtn').click(function() {
                    if (isPermanentDelete) {
                        // For permanent delete, we need to submit a form with anti-forgery token
                        const form = document.createElement('form');
                        form.method = 'post';
                        form.action = deleteFormUrl;

                        const token = $('input[name="__RequestVerificationToken"]').val();
                        const tokenInput = document.createElement('input');
                        tokenInput.type = 'hidden';
                        tokenInput.name = '__RequestVerificationToken';
                        tokenInput.value = token;
                        form.appendChild(tokenInput);

                        document.body.appendChild(form);
                        form.submit();
                    } else {
                        // For soft delete, just redirect
                        window.location.href = deleteFormUrl;
                    }

                    $('#confirmDeleteModal').modal('hide');
                });

                // Handle restore forms
                $('form[action*="Restore"]').on('submit', function(e) {
                    const orderId = $(this).attr('action').split('/').pop();
                    if (!confirm(`Restore order #${orderId}?`)) {
                        e.preventDefault();
                        return false;
                    }
                    return true;
                });

                // Export selected orders
                function exportSelectedOrders(orderIds) {
                    const url = '@Url.Action("Export")' + '?format=csv&orderIds=' + orderIds.join(',');
                    window.open(url, '_blank');
                    showAlert(`Exporting ${orderIds.length} orders...`, 'info');
                }

                // Tracking modal
                $(document).on('click', '.tracking-link', function(e) {
                    e.preventDefault();
                    const trackingNumber = $(this).data('tracking');
                    const carrier = $(this).data('carrier') || 'Unknown Carrier';

                    $('#trackingNumber').text(trackingNumber);
                    $('#trackingCarrier').text(carrier);

                    // Generate tracking URL based on carrier
                    let trackingUrl = '';
                    if (carrier.toLowerCase().includes('dhl')) {
                        trackingUrl = `https://www.dhl.com/en/express/tracking.html?AWB=${trackingNumber}`;
                    } else if (carrier.toLowerCase().includes('fedex')) {
                        trackingUrl = `https://www.fedex.com/fedextrack/?trknbr=${trackingNumber}`;
                    } else if (carrier.toLowerCase().includes('ups')) {
                        trackingUrl = `https://www.ups.com/track?tracknum=${trackingNumber}`;
                    } else if (carrier.toLowerCase().includes('courier guy')) {
                        trackingUrl = `https://thecourierguy.co.za/track-your-parcel/?tracking_number=${trackingNumber}`;
                    } else if (carrier.toLowerCase().includes('fastway')) {
                        trackingUrl = `https://www.fastway.co.za/tools/track`;
                    } else {
                        trackingUrl = `#`;
                    }

                    $('#trackingUrl').val(trackingUrl);
                    $('#openTrackingBtn').off('click').on('click', function() {
                        if (trackingUrl !== '#') {
                            window.open(trackingUrl, '_blank');
                        }
                    });

                    $('#trackingModal').modal('show');
                });

                // Clear filters
                $('#clearFiltersBtn').click(function() {
                    window.location.href = '@Url.Action("Index")';
                });

                // Refresh page
                $('#refreshBtn').click(function() {
                    location.reload();
                });

                // Auto-refresh every 30 seconds if there are pending orders
                @if (ViewBag.PendingOrders > 0 || ViewBag.ProcessingOrders > 0)
                {
                                <text>
                                setInterval(function() {
                                    location.reload();
                                }, 30000);
                                </text>
                }

                // Initialize DataTable with proper configuration
                $('#ordersTable').DataTable({
                    "pageLength": 25,
                    "order": [[1, 'desc']],
                    "language": {
                        "search": "Filter:",
                        "lengthMenu": "Show _MENU_ orders",
                        "info": "Showing _START_ to _END_ of _TOTAL_ orders",
                        "infoEmpty": "Showing 0 to 0 of 0 orders",
                        "infoFiltered": "(filtered from _MAX_ total orders)",
                        "zeroRecords": "No matching orders found"
                    },
                    "dom": '<"top"f>rt<"bottom"lip><"clear">',
                    "columnDefs": [
                        { "orderable": false, "targets": [0, 8, 9] }
                    ]
                });

                // Date range picker validation
                $('#startDate, #endDate').change(function() {
                    const startDate = $('#startDate').val();
                    const endDate = $('#endDate').val();

                    if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                        showAlert('End date cannot be earlier than start date', 'warning');
                        $(this).val('');
                    }
                });

                // Show alerts
                function showAlert(message, type = 'success') {
                    const alertClass = type === 'success' ? 'alert-success' :
                                     type === 'warning' ? 'alert-warning' :
                                     type === 'error' ? 'alert-danger' : 'alert-info';

                    const alertHtml = `
                        <div class="alert ${alertClass} alert-dismissible fade show fixed-top m-3" role="alert">
                            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle'} mr-2"></i>
                            ${message}
                            <button type="button" class="close" data-dismiss="alert">
                                <span>&times;</span>
                            </button>
                        </div>
                    `;

                    $('body').append(alertHtml);
                    setTimeout(() => $('.alert').alert('close'), 5000);
                }

                // Check for success/error messages from TempData
                @if (TempData["SuccessMessage"] != null)
                {
                            <text>
                            showAlert('@TempData["SuccessMessage"]', 'success');
                            </text>
                }
                @if (TempData["ErrorMessage"] != null)
                {
                            <text>
                            showAlert('@TempData["ErrorMessage"]', 'error');
                            </text>
                }

                // Update bulk action dropdown based on view mode
                $('#bulkActionSelect').change(function() {
                    $('#applyBulkActionBtn').prop('disabled', !$(this).val());
                });

                // Keyboard shortcuts
                $(document).keydown(function(e) {
                    // Ctrl + A to select all
                    if (e.ctrlKey && e.key === 'a') {
                        e.preventDefault();
                        $('#selectAll').click();
                    }

                    // Escape to clear selection
                    if (e.key === 'Escape') {
                        $('#clearSelectionBtn').click();
                    }

                    // Delete key to move to trash (when not showing deleted orders)
                    if (e.key === 'Delete' && '@ViewBag.ShowDeleted' !== 'True') {
                        e.preventDefault();
                        if (selectedOrders.length > 0) {
                            submitBulkAction('soft-delete');
                        }
                    }
                });

                // Show/hide columns based on screen size
                function adjustTableColumns() {
                    const width = $(window).width();
                    if (width < 768) {
                        $('#ordersTable').DataTable().columns([4, 6, 7]).visible(false);
                    } else {
                        $('#ordersTable').DataTable().columns([4, 6, 7]).visible(true);
                    }
                }

                $(window).resize(adjustTableColumns);
                adjustTableColumns();

                // Show loading indicator on form submissions
                $('form').on('submit', function() {
                    const $btn = $(this).find('button[type="submit"]');
                    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');
                });

                // Handle bulk permanent delete form submission
                $('#bulkDeleteForm').on('submit', function(e) {
                    if (selectedOrders.length === 0) {
                        e.preventDefault();
                        showAlert('Please select at least one order', 'warning');
                        return;
                    }

                    $('#deleteOrderIds').val(selectedOrders.join(','));

                    if (!confirm(`Permanently delete ${selectedOrders.length} selected order(s)? This action cannot be undone!`)) {
                        e.preventDefault();
                        return false;
                    }
                    return true;
                });

                // Handle bulk restore form submission
                $('#bulkRestoreForm').on('submit', function(e) {
                    if (selectedOrders.length === 0) {
                        e.preventDefault();
                        showAlert('Please select at least one order', 'warning');
                        return;
                    }

                    $('#restoreOrderIds').val(selectedOrders.join(','));

                    if (!confirm(`Restore ${selectedOrders.length} selected order(s)?`)) {
                        e.preventDefault();
                        return false;
                    }
                    return true;
                });
            });

        }

    </script>

}
@functions {
    private string GetStatusBadgeColor(string status)
    {
        return status switch
        {
            "Pending" => "warning",
            "Processing" => "info",
            "Shipped" => "primary",
            "Delivered" => "success",
            "Cancelled" => "danger",
            "Refunded" => "secondary",
            "On Hold" => "dark",
            _ => "secondary"
        };
    }

    private string GetPaymentBadgeColor(string paymentStatus)
    {
        return paymentStatus switch
        {
            "Paid" => "success",
            "Pending" => "warning",
            "Failed" => "danger",
            "Refunded" => "info",
            "Partially Refunded" => "info",
            _ => "secondary"
        };
    }
}