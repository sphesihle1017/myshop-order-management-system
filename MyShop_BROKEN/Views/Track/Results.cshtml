@model List<MyShop.Models.Checkout>
@{
    ViewData["Title"] = "Track Results";
    var searchTerm = ViewBag.SearchTerm ?? "your search";
}

<style>
    .results-container {
        max-width: 1200px;
        margin: 2rem auto;
    }

    .results-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .order-card {
        border: 1px solid #dee2e6;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }

        .order-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-color: #0d6efd;
        }

    .order-header {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
    }

    .order-body {
        padding: 1.5rem;
        display: none;
    }

        .order-body.show {
            display: block;
        }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: bold;
    }

    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-processing {
        background-color: #cfe2ff;
        color: #084298;
    }

    .status-shipped {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .status-delivered {
        background-color: #d4edda;
        color: #155724;
    }

    .order-detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f8f9fa;
    }

        .order-detail-row:last-child {
            border-bottom: none;
        }

    .track-timeline {
        position: relative;
        padding-left: 30px;
        margin-top: 2rem;
    }

        .track-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #dee2e6;
        }

    .timeline-item {
        position: relative;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
    }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 5px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #dee2e6;
            border: 3px solid white;
        }

        .timeline-item.completed::before {
            background-color: #198754;
        }

        .timeline-item.current::before {
            background-color: #0d6efd;
            animation: pulse 2s infinite;
        }

    .timeline-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        color: #6c757d;
    }

    .timeline-item.completed .timeline-icon {
        background-color: #198754;
        color: white;
    }

    .timeline-item.current .timeline-icon {
        background-color: #0d6efd;
        color: white;
    }

    .no-results {
        text-align: center;
        padding: 4rem 2rem;
    }

    .no-results-icon {
        font-size: 4rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }

    .new-search-btn {
        margin-top: 1rem;
    }

    @@keyframes pulse {
        0%

    {
        transform: scale(1);
    }

    50% {
        transform: scale(1.1);
    }

    100% {
        transform: scale(1);
    }

    }
</style>

<div class="results-container">
    <!-- Header -->
    <div class="results-header">
        <h2><i class="bi bi-search me-2"></i>Search Results</h2>
        <p class="lead mb-0">Found @Model.Count order(s) for @searchTerm</p>
        <a asp-action="Index" class="btn btn-outline-primary new-search-btn">
            <i class="bi bi-arrow-left me-1"></i>New Search
        </a>
    </div>

    @if (Model.Any())
    {
        @foreach (var order in Model)
        {
            <div class="order-card">
                <!-- Order Header (Clickable) -->
                <div class="order-header" onclick="toggleOrderDetails(@order.OrderId)">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h5 class="mb-1">Order #@order.OrderId</h5>
                            <p class="text-muted mb-0 small">
                                <i class="bi bi-calendar me-1"></i>
                                @order.OrderDate.ToString("dd MMM yyyy")
                            </p>
                        </div>
                        <div class="col-md-4 text-center">
                            <span class="status-badge @($"status-{order.OrderStatus?.ToLower()}")">
                                @order.OrderStatus
                            </span>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <h5 class="text-primary mb-0">R @order.Total.ToString("0.00")</h5>
                            <p class="text-muted mb-0 small">
                                @order.OrderItems.Sum(oi => oi.Quantity) item(s)
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Order Body (Collapsible) -->
                <div class="order-body" id="orderBody-@order.OrderId">
                    <div class="row">
                        <!-- Order Details -->
                        <div class="col-lg-6">
                            <h6><i class="bi bi-info-circle me-2"></i>Order Details</h6>
                            <div class="order-detail-row">
                                <span>Order ID:</span>
                                <strong>#@order.OrderId</strong>
                            </div>
                            <div class="order-detail-row">
                                <span>Order Date:</span>
                                <span>@order.OrderDate.ToString("dd MMMM yyyy hh:mm tt")</span>
                            </div>
                            <div class="order-detail-row">
                                <span>Customer:</span>
                                <span>@order.FirstName @order.LastName</span>
                            </div>
                            <div class="order-detail-row">
                                <span>Email:</span>
                                <span>@order.Email</span>
                            </div>
                            <div class="order-detail-row">
                                <span>Shipping To:</span>
                                <span>@order.City, @order.Country</span>
                            </div>
                            @if (!string.IsNullOrEmpty(order.TrackingNumber))
                            {
                                <div class="order-detail-row">
                                    <span>Tracking Number:</span>
                                    <strong class="text-primary">@order.TrackingNumber</strong>
                                </div>
                                <div class="order-detail-row">
                                    <span>Shipping Carrier:</span>
                                    <span>@order.ShippingCarrier</span>
                                </div>
                                @if (order.EstimatedDelivery.HasValue)
                                {
                                    <div class="order-detail-row">
                                        <span>Estimated Delivery:</span>
                                        <span>@order.EstimatedDelivery.Value.ToString("dd MMM yyyy")</span>
                                    </div>
                                }
                            }
                        </div>

                        <!-- Order Timeline -->
                        <div class="col-lg-6">
                            <h6><i class="bi bi-clock-history me-2"></i>Order Timeline</h6>
                            <div class="track-timeline" id="timeline-@order.OrderId">
                                <!-- Timeline will be loaded by JavaScript -->
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 small">Loading timeline...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-3 pt-3 border-top">
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-2">
                                <a asp-action="Details" asp-route-id="@order.OrderId"
                                   class="btn btn-outline-primary">
                                    <i class="bi bi-eye me-1"></i>View Full Details
                                </a>
                                <a asp-action="Subscribe" asp-route-orderId="@order.OrderId"
                                   asp-route-email="@order.Email"
                                   class="btn btn-outline-success">
                                    <i class="bi bi-bell me-1"></i>Get Updates
                                </a>
                                <button class="btn btn-outline-secondary" onclick="printOrder(@order.OrderId)">
                                    <i class="bi bi-printer me-1"></i>Print Summary
                                </button>
                                @if (!string.IsNullOrEmpty(order.TrackingNumber))
                                {
                                    <a href="https://www.dpd.co.uk/tracking/trackingSearch.do?search.searchType=0&search.parcelNumber=@order.TrackingNumber"
                                       target="_blank" class="btn btn-outline-info">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>Track on Carrier Site
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="no-results">
            <div class="no-results-icon">
                <i class="bi bi-search"></i>
            </div>
            <h3>No Orders Found</h3>
            <p class="lead">We couldn't find any orders matching your search.</p>
            <div class="mt-4">
                <a asp-action="Index" class="btn btn-primary">
                    <i class="bi bi-arrow-left me-2"></i>Try Another Search
                </a>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Toggle order details
        function toggleOrderDetails(orderId) {
            const orderBody = document.getElementById(`orderBody-${orderId}`);
            orderBody.classList.toggle('show');

            // Load timeline if not already loaded
            if (orderBody.classList.contains('show')) {
                loadOrderTimeline(orderId);
            }
        }

        // Load order timeline
        function loadOrderTimeline(orderId) {
            const timelineContainer = document.getElementById(`timeline-${orderId}`);

            // Check if already loaded
            if (timelineContainer.getAttribute('data-loaded') === 'true') {
                return;
            }

            fetch(`/Track/Timeline/${orderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderTimeline(timelineContainer, data.timeline, data.trackingNumber, data.shippingCarrier, data.estimatedDelivery);
                        timelineContainer.setAttribute('data-loaded', 'true');
                    }
                })
                .catch(error => {
                    console.error('Error loading timeline:', error);
                    timelineContainer.innerHTML = '<p class="text-danger">Failed to load timeline</p>';
                });
        }

        // Render timeline
        function renderTimeline(container, timeline, trackingNumber, shippingCarrier, estimatedDelivery) {
            let html = '';

            timeline.forEach((event, index) => {
                const isCurrent = index === timeline.findIndex(e => e.status === 'current');
                const isCompleted = event.status === 'completed';

                html += `
                    <div class="timeline-item ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}">
                        <div class="d-flex">
                            <div class="timeline-icon">
                                <i class="bi ${event.icon}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${event.title}</h6>
                                <p class="mb-1">${event.description}</p>
                                <small class="text-muted">
                                    <i class="bi bi-calendar me-1"></i>
                                    ${new Date(event.date).toLocaleDateString('en-US', {
                                        day: 'numeric',
                                        month: 'short',
                                        year: 'numeric'
                                    })}
                                </small>
                                ${event.trackingNumber ? `
                                    <div class="mt-2">
                                        <small class="badge bg-info">
                                            <i class="bi bi-upc-scan me-1"></i>
                                            ${event.trackingNumber}
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            // Add tracking info if available
            if (trackingNumber) {
                html += `
                    <div class="alert alert-info mt-3">
                        <h6><i class="bi bi-truck me-2"></i>Shipping Information</h6>
                        <p class="mb-1">
                            <strong>Tracking Number:</strong> ${trackingNumber}<br>
                            <strong>Carrier:</strong> ${shippingCarrier || 'Not specified'}<br>
                            ${estimatedDelivery ? `<strong>Estimated Delivery:</strong> ${estimatedDelivery}` : ''}
                        </p>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Print order summary
        function printOrder(orderId) {
            const printContent = document.getElementById(`orderBody-${orderId}`).innerHTML;
            const originalContent = document.body.innerHTML;

            document.body.innerHTML = `
                <html>
                    <head>
                        <title>Order #${orderId} Summary</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
                    </head>
                    <body>
                        <div class="container mt-4">
                            <h2 class="mb-4">Order #${orderId} Summary</h2>
                            ${printContent}
                        </div>
                    </body>
                </html>
            `;

            window.print();
            document.body.innerHTML = originalContent;
            window.location.reload();
        }

        // Auto-expand first order
        document.addEventListener('DOMContentLoaded', function() {
            const firstOrder = document.querySelector('.order-card');
            if (firstOrder) {
                const firstOrderId = firstOrder.querySelector('.order-header').getAttribute('onclick').match(/\d+/)[0];
                toggleOrderDetails(firstOrderId);
            }
        });
    </script>
}